FROM debian:bookworm-slim AS pre-runner

RUN apt-get update && apt-get upgrade -y && \
    mkdir -p /var/lib/sqlite

# syntax = docker/dockerfile:1-experimental
FROM gcr.io/distroless/base-nossl-debian12:nonroot AS runner

# Copy pre-built binary based on target architecture
ARG TARGETARCH

COPY --from=pre-runner --chown=nonroot:nonroot /var/lib/sqlite /var/lib/sqlite
COPY --chown=nonroot:nonroot kratos-${TARGETARCH} /usr/bin/kratos

VOLUME /var/lib/sqlite

# Declare the standard ports used by Kratos (4433 for public service endpoint, 4434 for admin service endpoint)
EXPOSE 4433 4434

ENTRYPOINT ["kratos"]
CMD ["serve"]
